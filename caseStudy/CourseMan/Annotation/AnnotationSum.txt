--Ghi chú: A>2 , min=2; A>=2, minLim=2; B<3, max=3, B<=3; maxLim=3; matchVal='Const', matchVal= 'Attribute'
--1. Equality / Reconciliation
--a) Khi GRADUATED: tổng CORE đã hoàn tất ≥ minCoreCredits của  Program ACTIVE
-- (Hoàn tất = e.status = COMPLETED và grade không thuộc {'F','I','W'}; Enrolment.grade là String)
context Student
inv cm01_CoreCreditsRequirement:
  self.status = StudentStatus::GRADUATED implies
  	self.enrolment ->select(e | e.grade >='C'
                         and e.offering.module.type = CourseType::CORE)
        ->collect(e | e.offering.module.credits)->sum()
        >= self.programEnrolment.program.minCoreCredits 
AnnotationSum
@SumConstraint(
    name = 'cm01_CoreCreditsRequirement',
    assocCls =@AssocCls(assoc={'Enrolment',programEnrolment}),
    rolePath = @RolePath(role= {'offering','module'}),
    collect = {
        @AttrCond(attr = 'grade', minLim = 'C'),
        @AttrCond(attr = 'type', matchVal = 'CourseType::CORE')
    },
    sumAttr = 'credits',
    fixAttr = {
        @RolePath(role = {'program'}),
        @AttrRef(minLim = 'minCoreCredits')
    }
)

 -- b) Total credits ≥ chuẩn khi tốt nghiệp
context Student
inv cm02_TotalCreditsRequirement:
  self.status = StudentStatus::GRADUATED implies
    self.enrolment
      ->select(e | e.grade >= 'C')
      ->collect(e | e.offering.module.credits)->sum()
    >= self.programEnrolment.program.minTotalCredits
	
	@SumConstraint(
    name     = 'cm02_TotalCreditsRequirement',
    assocCls =@AssocCls(assoc={'Enrolment',programEnrolment}),
    rolePath = @RolePath(role= {'offering','module'}),
	  collect  = {@AttrCond(attr='status', matchVal='StudentStatus::GRADUATED'), 
            @AttrCond(attr = 'grade', minLim = 'C')        
    },
    sumAttr  = 'credits',                               
    fixAttr  = {                                         
        @RolePath(role={'program'}),
        @AttrRef(minLim = 'minTotalCredits')
    }
)


	-- c)  So sánh số liệu: Tổng = core + elective 
context Student
inv cm03_ReconcileCoreElectiveBreakdown:
  let total : Integer =
    self.enrolment->select(e | e.grade >= 'C')
      ->collect(e | e.offering.module.credits)->sum()
  in
  let core : Integer =
    self.enrolment
      ->select(e | e.grade >= 'C' and e.offering.module.type = CourseType::CORE)
      ->collect(e | e.offering.module.credits)->sum()
  in
  let elective : Integer =
    self.enrolment
      ->select(e | e.grade >= 'C' and e.offering.module.type = CourseType::ELECTIVE)
      ->collect(e | e.offering.module.credits)->sum()
  in
  total = core + elective
  
  // total:
@SSumConstraint(
    name     = 'cm03_total',
    assocCls =@AssocCls(assoc={'Enrolment'}),
    rolePath = @RolePath(role= {'offering','module'}),
    collect  = {
        @AttrCond(attr = 'grade', minLim = 'C')
    },
    sumAttr  = 'credits',
   collect1  = {
        @AttrCond(attr = 'grade', minLim = 'C'),
        @AttrCond(attr = 'type',  matchVal = 'CORE') // e.offering.module.type = CORE
    },
	sumAttr1 = 'credits',
		collect 2 = {
        @AttrCond(attr = 'grade', minLim = 'C'),
        @AttrCond(attr = 'type',  matchVal = 'ELECTIVE')
    },
    sumAttr2  = 'credits',
	fixAttr = {
			@CompCond(val=sumAttr, matchVal=sumAttr1+sumAttr2)}
)
 
-- 2) Bounds (Min/Max/Range) áp cho tổng
--a)core không vượt tổng
context Student
inv cm04_CoreWithinTotalBound:
  let total : Integer =
    self.enrolment->select(e | e.grade >= 'C')
      ->collect(e | e.offering.module.credits)->sum()
  in
  let core : Integer =
    self.enrolment
      ->select(e | e.grade >= 'C' and e.offering.module.type = CourseType::CORE)
      ->collect(e | e.offering.module.credits)->sum()
  in
  core <= total

@SumConstraint(
	name='cm04_total',  
  assocCls =@AssocCls(assoc={'Enrolment'}),
  rolePath = @RolePath(role= {'offering','module'}),
	sumAttr='credits',
	collect2={ @AttrCond(attr='grade', minLim='C'),
            @AttrCond(attr='type',  matchVal='CourseType::CORE') },
	sumAttr1='credits',
	fixAttr={@CompCond(val=sumAttr, maxLim=sumAttr1)}
 )

--b) Bảo đảm phần tín chỉ tự chọn đủ để đạt minTotalCredits sau khi đã thỏa minCoreCredits.
context Student
inv cm05_ElectiveFloorAtGraduation:
  self.status = StudentStatus::GRADUATED implies (
    let requiredElectiveCredits : Integer = 
        self.programEnrolment.program.minTotalCredits - self.programEnrolment.program.minCoreCredits
    in
    let actualElectiveCredits : Integer =
        self.enrolment->select(e | e.isPassed and e.offering.module.type = CourseType::ELECTIVE)
        ->collect(e | e.offering.module.credits)->sum()
    in
    actualElectiveCredits >= requiredElectiveCredits
	)
SumConstraint(
	name     = 'cm05_ElectiveFloorAtGraduation',
  assocCls =@AssocCls(assoc={'Enrolment', programEnrolment}),
  rolePath = @RolePath(role= {'offering','module'}),
	collect  = {
		@AttrCond(attr='status', matchVal='StudentStatus::GRADUATED'), 
		@AttrCond(attr='grade', minLim='C'),
		@AttrCond(attr='type',  matchVal='CourseType::ELECTIVE')},
	sumAttr  = 'credits',
	fixAttr  = {                                    
        @RolePath(role = {'program'}),
		cacu = @Cacu(attr='minTotalCredits', sub='minCoreCredits'),
		@CompCond(val=sumAttr, minLim=cacu)
    }

)

--3) Group-Wise / Relative Constraints 
-- a) Academic Probation Rules (Common)
context Student
inv cm06_AcademicProbationRules:
  self.overallStatus = AcademicStatus::PROBATION implies
    self.enrolment->select(e | e.status = EnrolStatus::ACTIVE)
      ->collect(e | e.offering.module.credits)->sum() <= 12
	  
@SumConstraint(
	name     = 'cm06_AcademicProbationRules',
  assocCls =@AssocCls(assoc={'Enrolment'}),
  rolePath = @RolePath(role= {'offering','module'}),
	collect  = { @AttrCond(attr='status', matchVal='EnrolStatus::ACTIVE')  
  },
	sumAttr  = 'credits',
	fixAttr  = { @AttrRef(maxLim=12)}
  ifPart ={@AttrCond(attr='overallStatus', matchVal='AcademicStatus::PROBATION') }         
)
	  
  --b) Credit Limit per Term
  -- The constraint ensures that, within a given term,
  the total number of credits a student may enroll in does not exceed maxCreditsPerTerm.
context Student
inv courseMan_inv07_CurrentTermCreditsLimit: self.enrolment
    ->select(e | e.offering.term.isCurTerm = true and e.status = EnrolStatus::ACTIVE)
    ->collect(e | e.offering.module.credits)
    ->sum() <= self.programEnrolment.program.maxCreditsPerTerm
  
  @SumConstraint(
  name     = 'cm07_CurrentTermCreditsLimit',
  assocCls =@AssocCls(assoc={'Enrolment', 'programEnrolment'}),
  rolePath = @RolePath(role= {'offering','module'}),
  collect  = { @AttrCond(attr='isCurTerm', matchVal='true')
					@AttrCond(attr='status', matchVal='EnrolStatus::ACTIVE') },
  sumAttr  = 'credits',
  fixAttr  = {
    @RolePath(role={'program'}),
	  @AttrRef(maxLim = 'maxCreditsPerTerm')
  }
)

  
--c) constraint tracking/monitoring
	context Student  
inv cm08_TuitionAffordability:
  let totalOutstandingTuition : Real =
    self.enrolment
      ->select(e | e.status = EnrolStatus::ACTIVE or e.status = EnrolStatus::PLANNED)
      ->collect(e | e.offering.module.tuitionFee)->sum()
  in
    totalOutstandingTuition <= self.balance + self.aidCap
	
@SumConstraint(
	name     = 'cm08_AcademicProbationRules',
  assocCls =@AssocCls(assoc={'Enrolment'}),
  rolePath = @RolePath(role= {'offering','module'}),
	collect  = {
		@AttrCond(attr='status', matchVal='EnrolStatus::ACTIVE'),
		@AttrCond(attr ='status', matchVal ='EnrolStatus::PLANNED', neg = true)
	},
	sumAttr  = 'credits',
	fixAttr  = { 
		cacu = @Cacu(attr='balance', add='aidCap'),
		@CompCond(val=sumAttr, maxLim=cacu) }
)

	
--==============class Program
-- 1) Trần học phí theo từng Program cho mọi ProgramEnrolment ACTIVE (theo kỳ hiện tại)
context Program
inv cm09_TuitionCapPerCurrentTerm:
  self.programEnrolment
    ->select(pe | pe.status = EnrolProStatus::ACTIVE)
    ->forAll(pe |
      let curTerm : AcademicTerm = pe.student.curTerm in
      curTerm <> null implies
        pe.student.enrolmentE
          ->select(e | e.offering.term = curTerm and e.status = EnrolStatus::ENROLLED)
          ->collect(e | e.offering.module.tuitionFee)->sum()
        <= self.tuitionCap
    )
@SumConstraint(
  name     = 'cm09_TuitionCapPerCurrentTerm',
  assocCls =@AssocCls(assoc={'Enrolment', 'ProgramEnrolment'}),
  rolePath = @RolePath(role= {'student','offering','module'}),
  rolePath2 = @RolePath(role= {'term','termRecord'}),
  collect  = {
	@AttrCond( attr='status', matchVal='EnrolProStatus::ACTIVE'),
    @AttrCond( attr='term', matchVal='curTerm'),
    @AttrCond(attr='status', matchVal='EnrolStatus::ENROLLED')
  },
  sumAttr  = 'tuitionFee',
  fixAttr  = { @AttrRef(maxLim='tuitionCap') }   
)

-- 2) Giới hạn tín chỉ tối đa/kỳ theo Program cho mọi ProgramEnrolment ACTIVE (kỳ hiện tại)
context Program
inv cm10_MaxCreditsPerCurrentTerm:
  self.programEnrolment
    ->select(pe | pe.status = EnrolProStatus::ACTIVE)
    ->forAll(pe |
      let curTerm : AcademicTerm = pe.student.curTerm in
      curTerm <> null implies
        pe.student.enrolment
          ->select(e | e.offering.term = curTerm and e.status = EnrolStatus::ACTIVE)
          ->collect(e | e.offering.module.credits)->sum()
        <= self.maxCreditsPerTerm
    )

@SumConstraint(
  name     = 'cm10_MaxCreditsPerCurrentTerm',
    assocCls =@AssocCls(assoc={'Enrolment', 'ProgramEnrolment'}),
  rolePath = @RolePath(role= {'student', 'offering','module'}),
  collect  = {
	@AttrCond( attr='status', matchVal='EnrolProStatus::ACTIVE'),
    @AttrCond(attr='term', matchVal='curTerm'),
    @AttrCond(attr='status', matchVal='EnrolStatus::ACTIVE')
  },
  sumAttr  = 'credits',
  fixAttr  = { @AttrRef(maxLim='maxCreditsPerTerm') }   
)

	
--==============ProgramEnrolment
-- 3) Chuẩn tốt nghiệp (tổng & core đã hoàn tất, qua môn)
context ProgramEnrolment
inv cm11_GraduationThresholds:
  (self.student.status = StudentStatus::GRADUATED) implies (
    let total : Integer =
      self.student.enrolment
        ->select(e | e.status = EnrolStatus::COMPLETED and e.grade >= 'C')
        ->collect(e | e.offering.module.credits)->sum()
    in
    let core : Integer =
      self.student.enrolment
        ->select(e | e.status = EnrolStatus::COMPLETED and e.grade >= 'C'
                      and e.offering.module.type = CourseType::CORE)
        ->collect(e | e.offering.module.credits)->sum()
    in
    total >= self.program.minTotalCredits and core >= self.program.minCoreCredits
  )
  
@SumConstraint(
    name     = 'cm11_totalCreditsCompleted',
    assocCls =@AssocCls(assoc={'Enrolment', 'ProgramEnrolment'}),
    rolePath = @RolePath(role= {'student', 'offering','module'}),
    collect1  = { 
			@AttrCond(attr='status', matchVal='StudentStatus::GRADUATED'),
			@AttrCond(attr='status', matchVal='EnrolStatus::COMPLETED'),
             @AttrCond(attr='grade',  minLim=''C'') },
  sumAttr1  = 'credits',
  fixAttr  = { 
				@RolePath(role={'program'}),
				@AttrRef(minLimAttr = 'minTotalCredits')},

collect2  = { @AttrCond(attr='status', matchVal='EnrolStatus::COMPLETED'),
               @AttrCond(attr='grade',  minLim=''C''),
               @AttrCond(attr='type',   matchVal='CourseType::CORE') },
  sumAttr2  = 'credits',
  fixAttr  = { 
      	@RolePath(role={'program'}),
				@AttrRef(minLimAttr = 'minCoreCredits')}
)
  
-- 4) Max tín chỉ cho kỳ hiện tại (phạm vi ProgramEnrolment)
context ProgramEnrolment
inv cm12_CurrentTermMaxCredits:
  let curTerm : AcademicTerm = self.student.curTerm in
  curTerm <> null implies
    self.student.enrolment
      ->select(e | e.offering.term = curTerm and e.status = EnrolStatus::ENROLLED)
      ->collect(e | e.offering.module.credits)->sum()
    <= self.program.maxCreditsPerTerm
	
	@SumConstraint(
  name     = 'cm12_PerTermMaxCredits',
    assocCls =@AssocCls(assoc={'Enrolment', 'ProgramEnrolment'}),
    rolePath = @RolePath(role= {'student', 'offering','module'}),
    rolePath2 = @RolePath(role= {'term', 'termRecord'}),
  collect  = {
    @AttrCond(attr='status', matchVal='EnrolStatus::ENROLLED')
  },
  sumAttr  = 'credits',
  fixAttr  = { 
	  @RolePath(role={'program'}),
	  @AttrRef(maxLim=maxCreditsPerTerm') } 
)


-- 5) Trần học phí cho kỳ hiện tại (phạm vi ProgramEnrolment)
context ProgramEnrolment
inv cm13_CurrentTermTuitionCap:
  let curTerm : AcademicTerm = self.student.curTerm in
  curTerm <> null implies
    self.student.enrolment
      ->select(e | e.offering.term = curTerm and e.status = EnrolStatus::ENROLLED)
      ->collect(e | e.offering.module.tuitionFee)->sum()
    <= self.program.tuitionCap
	
@SumConstraint(
  name     = 'cm13_CurrentTermTuitionCap',
    assocCls =@AssocCls(assoc={'Enrolment', 'ProgramEnrolment'}),
    rolePath = @RolePath(role= {'student', 'offering','module'}),
    rolePath2 = @RolePath(role= {'term', 'termRecord'}),
  collect  = {
    @AttrCond(attr='status', matchVal='EnrolStatus::ENROLLED')
  },
  sumAttr  = 'tuitionFee',
  fixAttr  = { 
  	@RolePath(role={'program'}),
	  @AttrRef(maxLim='tuitionCap') } 
)


--=======================TermRecord
-- 6) Tối đa tín chỉ/kỳ (dựa Program.maxCreditsPerTerm)
context TermRecord
inv cm14_MaxCreditsPerTerm:
  self.student.enrolment
    ->select(e | e.offering.term = self.term and e.status = EnrolStatus::ACTIVE)
    ->collect(e | e.offering.module.credits)->sum()
  <= self.student.programEnrolment.program.maxCreditsPerTerm

@SumConstraint(
  name     = 'cm14_MaxCreditsPerTerm',
    assocCls =@AssocCls(assoc={'Enrolment', 'ProgramEnrolment'}),
    rolePath = @RolePath(role= {'student', 'offering','module'}),
        rolePath2 = @RolePath(role= {'term', 'termRecord'}),
  collect  = {
    @AttrCond(attr='status', matchVal='EnrolStatus::ACTIVE')
  },
  sumAttr  = 'credits',
  fixAttr  = {
     	@RolePath(role={'program'}),
    @AttrRef(maxLim='maxCreditsPerTerm')
  }
)

-- 7) Trần học phí/kỳ (dựa Program.tuitionCap)
context TermRecord
inv cm15_TuitionWithinProgramCap:
  self.student.enrolment
    ->select(e | e.offering.term = self.term and e.status = EnrolStatus::ENROLLED)
    ->collect(e | e.offering.module.tuitionFee)->sum()
  <= self.student.programEnrolment.program.tuitionCap

@SumConstraint(
  name     = 'cm15_TuitionWithinProgramCap',
    assocCls =@AssocCls(assoc={'Enrolment', 'ProgramEnrolment'}),
    rolePath = @RolePath(role= {'student', 'offering','module'}),
        rolePath2 = @RolePath(role= {'term', 'termRecord'}),
  collect  = {
    @AttrCond(attr='status', matchVal='EnrolStatus::ENROLLED')
  },
  sumAttr  = 'tuitionFee',
  fixAttr  = {
     	@RolePath(role={'student'}),
      @AttrRef(maxLim='tuitionCap')
  }
)

-- 8) Cân đối core ≤ tổng (trong kỳ)
context TermRecord
inv cm16_CoreWithinTotalInTerm:
  let total : Integer =
    self.student.enrolment
      ->select(e | e.offering.term = self.term and e.status = EnrolStatus::ENROLLED)
      ->collect(e | e.offering.module.credits)->sum()
  in
  let core : Integer =
    self.student.enrolment
      ->select(e | e.offering.term = self.term and e.status = EnrolStatus::ENROLLED
                    and e.offering.module.type = CourseType::CORE)
      ->collect(e | e.offering.module.credits)->sum()
  in
  core <= total

@SumConstraint(
  name     = 'cm16_CoreWithinTotalInTerm',
    assocCls =@AssocCls(assoc={'Enrolment'}),
    rolePath = @RolePath(role= {'student', 'offering','module'}),
    rolePath2 = @RolePath(role= {'term', 'termRecord'}),
  collect1 = {
    @AttrCond(attr='status', matchVal='EnrolStatus::ENROLLED')
  },
  sumAttr1  = 'credits',
  collect2  = {
    @AttrCond(attr='status', matchVal='EnrolStatus::ENROLLED'),
    @AttrCond(attr='type',   matchVal='CourseType::CORE')
  },
  sumAttr2  = 'credits',
  fixAttr = {@CompCond(val = sumAttr1, maxLim=sumAttr2)}
)
  
--=======================AcademicTerm
    --This constraint ensures that students with a GPA below 2.5 in the previous semester are allowed to enroll in a maximum of 20 credits.
context TermRecord
inv cm17_LowGPACreditRestriction:
  let isCurTerm : Boolean = self.term.isCurTerm in
  isCurTerm implies (
    let prevSemester : Integer = self.studySemester - 1 in
    let hadLowPrevGPA : Boolean = self.student.termRecord
        ->exists(tr | tr.studySemester = prevSemester 
                and tr.gpa < 2.5) in
    let curCredits : Integer = self.student.enrolment
        ->select(e | e.offering.term = self.term 
            and e.status = EnrolStatus::ACTIVE)
        ->collect(e | e.offering.module.credits)->sum() in
    hadLowPrevGPA implies (curCredits <= 20)
  )
  @SumConstraint(
  name     =  'cm17_LowGPACreditRestriction ',
    assocCls =@AssocCls(assoc={'Enrolment'}),
    rolePath = @RolePath(role= {'student', 'offering','module'}),
    rolePath2 = @RolePath(role= {'term', 'termRecord'}),
  collect  = {
      @AttrCond(attr =  'isCurTerm ', matchVal =  'true '),
      @AttrCond(attr =  'status ',   matchVal  =  'EnrolStatus::ACTIVE ')
    },
  sumAttr  = 'credits ', 
  fixAttr  ={ @AttrRef(maxLim =  20) },
  ifPart   ={@AttrCond(attr ='prevSemGpa', maxLim =2.5) }
)
--===================
context TermRecord
inv cm17v1_LowGPACreditRestriction:
  self.term.isCurTerm = true implies (
    self.prevSemGpa < 2.5
    implies
      self.student.enrolment
        ->select(e |
           e.status = EnrolStatus::ACTIVE and
           e.offering.term = self.term
        )
        ->collect(e | e.offering.module.credits)
        ->sum() <= 20
  )

context TermRecord 
inv  cm17v2_LowGPACreditRestriction:
 let forAll(
      ->select(e | e.student.curTerm = true and  e.status = EnrolStatus::ACTIVE) 
     ->collect(e | e.course.credits)->sum() in 
         self.prevSemGpa < 2.5 implies s <= 20

context TermRecord
inv cm17v3_LowGPACreditRestriction:
  let isCurTerm : Boolean = self.term.isCurTerm in
  isCurTerm implies (
      let hadLowPrevGPA : Boolean = self.student.termRecord
        ->exists(tr | tr.gpa < 2.5) in
    let curCredits : Integer = self.student.enrolment
        ->select(e | e.offering.term = self.term 
            and e.status = EnrolStatus::ACTIVE)
        ->collect(e | e.offering.module.credits)->sum() in
    hadLowPrevGPA implies (curCredits <= 20)
  )
======================
 @SumConstraint(
    name  =  'cm17v1_LowGPACreditRestriction ',
    assocCls = @AssocCls(assoc= {'Enrollments'}),
    rolePath =@RolePath( role = {'offering', 'module', 'term', 'student'})
    rolePath2 = @RolePath(role = {'term', 'termRecord'}),
    collect  = {
      @AttrCond(attr =  'curTerm', matchVal =  'true '),
      @AttrCond(attr =  'status ', matchVal  = 'EnrolStatus::ACTIVE')
    },
  sumAttr  = 'credits ', 
  fixAttr  ={ @AttrRef(maxLim =  20) },
  ifPart={ @AttrCond(attr='prevSemGpa',maxLim=2.5 )}
 )

 @SumConstraint(
  name      =  'cm17_LowGPACreditRestriction',
  assocCls  = @AssocCls(assoc= {'Enrollments'}),
  rolePath  = @RolePath(role = {'student, 'offering', 'module'}),
  rolePath2 = @RolePath(role = {'term', 'termRecord'}),
  collect   = {
      @AttrCond(attr = 'curTerm', matchVal = true),
      @AttrCond(attr = 'status', matchVal = 'EnrolStatus::ACTIVE')
    },
  sumAttr   = 'credits', 
  fixAttr   = {@AttrRef(maxLim = 20) },
  ifPart    = {@AttrCond(attr='prevSemGpa', maxLim = 2.5) }
 )


class TermRecord { ... }
-- 9) Mọi sinh viên trong kỳ hiện tại không vượt max tín chỉ/kỳ theo Program
context AcademicTerm
inv cm18_CurrentTermStudentsRespectMaxCredits:
  self.isCurTerm = true implies
    Student.allInstances()->forAll(s |
      s.enrolment->exists(e | e.offering.term = self) implies
        s.enrolment
          ->select(e | e.offering.term = self and e.status = EnrolStatus::ENROLLED)
          ->collect(e | e.offering.module.credits)->sum()
        <= s.programEnrolment.program.maxCreditsPerTerm
    )
    @SumConstraint(
  name     = 'cm18_AllStudentsRespectMaxCredits',
    assocCls = @AssocCls(assoc= {'Enrollments','programEnrolment'}),
    rolePath =@RolePath( role = {'offering', 'module', 'term', 'student'})
    rolePath2 = @RolePath(role = {'term', 'termRecord'}),
    collect  = {
         @AttrCond(attr='status', matchVal='EnrolStatus::ENROLLED')
  },
  sumAttr  = 'credits',
  fixAttr  = {
    @RolePath(role={'program'}),
    @AttrRef(maxLim='maxCreditsPerTerm')
  }
)
-- 10) Mọi sinh viên trong kỳ hiện tại không vượt trần học phí/kỳ theo Program
context AcademicTerm
inv cm19_CurrentTermStudentsRespectTuitionCap:
  self.isCurTerm = true implies
    Student.allInstances()->forAll(s |
      s.enrolment->exists(e | e.offering.term = self) implies
        s.enrolment
          ->select(e | e.offering.term = self and e.status = EnrolStatus::ACTIVE)
          ->collect(e | e.offering.module.tuitionFee)->sum()
        <= s.programEnrolment.program.tuitionCap
    )

@SumConstraint(
  name     = 'cm19_AllStudentsRespectTuitionCap',
  assocCls = @AssocCls(assoc= {'Enrollments','programEnrolment'}),
  rolePath =@RolePath( role = {'offering', 'module', 'term', 'student'})
  rolePath2 = @RolePath(role = {'term', 'termRecord'}),
  collect  = {
    @AttrCond(attr='status', matchVal='EnrolStatus::ACTIVE')
  },
  sumAttr  = 'tuitionFee',
  fixAttr  = {
    @RolePath(role={'Student','program'),
    @AttrRef(maxLim='tuitionCap')
  }
)
